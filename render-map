#!/usr/bin/env bash
set -eu

function copy-output {
  if [[ $1 == -* ]]; then
    local name=map
  else
    local name=$1
  fi
  local path=~/Downloads/$name.pdf
  mkdir -p "${path%/*}"
  sudo cp /var/lib/machines/ocitysmap/root/ocitysmap/citymap.pdf "$path"
  sudo chown "$USER": "$path"
  echo "Output: $path"
}

function main {
  render-map "${@?An argument is required.}"
  copy-output "$1"
}

function render-map {
  sudo systemd-nspawn -q -M ocitysmap --chdir=/root/ocitysmap bash -eu"$-" -c '
  /etc/init.d/postgresql start
  if [[ ${1-} && $1 != -* ]]; then
    name=$1
    shift
    set -- -t "$name" --osmid="$(sudo -i -u postgres psql -A -c "SELECT osm_id FROM planet_osm_polygon WHERE name ILIKE '\''%$name%'\'' LIMIT 1" -d maposmatic | sed -n '2p')" "$@"
  fi
  ./render.py -l multi_page --paper-format="Din A5" "$@"
  if [[ -f ./links.ps && -f ./toc.ps ]]; then
    gs -o ./map.pdf -sDEVICE=pdfwrite ./citymap.pdf ./links.ps ./toc.ps
    mv ./map.pdf ./citymap.pdf
  fi
  ' -- "$@"
}

main "$@"
